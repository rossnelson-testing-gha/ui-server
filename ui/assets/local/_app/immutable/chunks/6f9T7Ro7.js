import{g as l,w as y}from"./s0RhsljA.js";import{A as n}from"./TBME1SPK.js";import{g as I}from"./Cf9asbMp.js";import{p as w}from"./DA_UWTYL.js";import{t as T}from"./DoIGSjBX.js";import{s as f}from"./CTBtQUu0.js";import{r as c,a as m}from"./ZXFOmz7Q.js";import{c as p,d as i}from"./UO4RgiCl.js";import{i as h}from"./8b9VeVr0.js";const k=e=>e.map(o=>o.runId).reduce((o,r,s,u)=>(o+=`RunId="${r}"`,s!==u.length-1&&(o+=" OR "),o),""),j=(e,t)=>{const o=I().email;switch(e){case n.Cancel:return{cancellationOperation:{identity:o}};case n.Terminate:return{terminationOperation:{identity:o}};case n.Reset:return{resetOperation:{identity:o,options:t==="first"?{firstWorkflowTask:{}}:{lastWorkflowTask:{}},resetType:t==="first"?1:2}}}},R=({id:e,runId:t})=>({workflowId:e,runId:t}),b=(e,t)=>{const o={jobId:t.jobId,namespace:t.namespace,reason:t.reason,...j(e,t.resetType)};if(t.workflows)return h(l(T),"1.19")?{...o,executions:t.workflows.map(R)}:{...o,visibilityQuery:k(t.workflows)};if(t.query)return{...o,visibilityQuery:t.query}};async function Q(e){const t=c("batch-operations",{namespace:e.namespace,batchJobId:e.jobId}),o=b(n.Cancel,e);await m(t,{options:{method:"POST",body:f(o)},notifyOnError:!1}),a.set({jobId:o.jobId,namespace:o.namespace})}async function V(e){const t=c("batch-operations",{namespace:e.namespace,batchJobId:e.jobId}),o=b(n.Terminate,e);await m(t,{options:{method:"POST",body:f(o)},notifyOnError:!1}),a.set({jobId:o.jobId,namespace:o.namespace})}const v=async e=>{const t=c("batch-operations",{namespace:e.namespace,batchJobId:e.jobId}),o=b(n.Reset,e);await m(t,{options:{method:"POST",body:f(o)},notifyOnError:!1}),a.set({jobId:o.jobId,namespace:o.namespace})};async function d({namespace:e,jobId:t}){return new Promise((o,r)=>{g({namespace:e,jobId:t}).then(({state:s,completeOperationCount:u})=>{s==="Failed"?r():s!=="Running"?o(u):setTimeout(()=>{try{o(d({namespace:e,jobId:t}))}catch{r()}},5e3)})})}async function g({jobId:e,namespace:t},o=fetch){const r=c("batch-operations",{namespace:t,batchJobId:e}),s=await m(r,{request:o});return C(s)}const C=e=>({...e,operationType:p(e.operationType),state:i(e.state),startTime:e.startTime,closeTime:e.closeTime,totalOperationCount:parseInt((e==null?void 0:e.totalOperationCount)??"0",10),completeOperationCount:parseInt((e==null?void 0:e.completeOperationCount)??"0",10),failureOperationCount:parseInt((e==null?void 0:e.failureOperationCount)??"0",10)});async function N(e,t=fetch){const o=c("batch-operations.list",{namespace:e,batchJobId:""}),r=await m(o,{request:t});return{nextPageToken:r.nextPageToken,operations:r.operationInfo?r.operationInfo.map(P):[]}}const P=e=>({startTime:e.startTime,closeTime:e.closeTime,jobId:e.jobId,state:i(e.state)}),a=y();a.subscribe(async e=>{e&&await d(e).then(()=>a.set(void 0))});const U=w("auto-refresh-batch-operation",!1);export{U as a,Q as b,v as c,g as d,V as e,a as i,N as l};
